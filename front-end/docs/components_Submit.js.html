<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>components/Submit.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#Alert">Alert</a></li><li><a href="global.html#App">App</a></li><li><a href="global.html#Home">Home</a></li><li><a href="global.html#Layout">Layout</a></li><li><a href="global.html#Login">Login</a></li><li><a href="global.html#MapComponent">MapComponent</a></li><li><a href="global.html#Navbar">Navbar</a></li><li><a href="global.html#Signup">Signup</a></li><li><a href="global.html#SubmissionPage">SubmissionPage</a></li><li><a href="global.html#isAuthenticated">isAuthenticated</a></li><li><a href="global.html#reportWebVitals">reportWebVitals</a></li><li><a href="global.html#router">router</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">components/Submit.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { useState } from 'react';
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import {wait} from "@testing-library/user-event/dist/utils";
import {useOutletContext} from "react-router-dom";

import L from 'leaflet';
import iconUrl from './images/marker-icon.png';
/**
 * SubmissionPage is a React component that allows users to submit information about student discounts.
 * It includes form inputs for establishment details and discount descriptions. Upon submission,
 * the address is geocoded to display a marker on a map. The form and map are interactively connected
 * so that submitting the form updates the map with a new marker.
 *
 * @function SubmissionPage
 * @param {function} handleSubmit - Handles the form submission, validates form data, performs geocoding,
 *        submits the data to the server, and updates the map if geocoding is successful.
 * @param {function} geocodeAddress - Converts the address entered into geographical coordinates (latitude and longitude)
 *        using the OpenCage Geocode API.
 * @param {Object[]} formData - State variables to store user input and geocoded location.
 * @param {Object} customIcon - Custom Leaflet icon to display markers with a unique appearance.
 * @returns {JSX.Element} A JSX element that renders a form for submitting discount information and a map showing the location.
 */

function SubmissionPage() {
    // State variables to store form data
    const [establishmentName, setEstablishmentName] = useState('');
    const [address, setAddress] = useState('');
    const [city, setCity] = useState('');
    const [state, setState] = useState('');
    const [zip, setZip] = useState('');
    const [location, setLocation] = useState(null); 
    const [discount, setDiscount] = useState('');
    const [submitterID, setSubmitterID] = useState(1);
    const [lat, setLat] = useState(0);
    const [lng, setLng] = useState(0);

    const { userID } = useOutletContext();
    const { jwtToken } = useOutletContext();
    const [DisplayData, setDisplayData] = useState('');

    const customIcon = new L.Icon({
        iconUrl: iconUrl, // Adjust this path if the image is in the public directory
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    const geocodeAddress = async () => {
        const fullAddress = `${address}, ${city}, ${state}, ${zip}`;
        const apiUrl = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(fullAddress)}&amp;key=${process.env.REACT_APP_OPENCAGE_API_KEY}`;

        console.log("Rendering Marker with:", establishmentName, discount);
        
        return fetch(apiUrl) // Return the fetch promise
            .then(response => response.json())
            .then(data => {
                if (data.results &amp;&amp; data.results.length > 0) {
                    const { lat, lng } = data.results[0].geometry;
                    setLocation({ lat, lng }); // Update location state
                    return { lat, lng };
                } else {
                    alert('Unable to geocode address.');
                    return null;
                }
            }).catch(error => {
                console.error('Geocoding error:', error);
                alert('Error geocoding address. Please try again.');
                return null;
            });
    };

    // Function to handle form submission
    const handleSubmit = async (e) => {
        e.preventDefault();
        console.log({ establishmentName, address, city, state, zip, location, discount, submitterID });

        // Perform the geocoding and update the map
        geocodeAddress().then(() => {
            console.log("Geocoding complete.")
        });

        // Check if the user is logged in
        if (jwtToken === '') {
            alert('Please log in to submit a review.');
            return;
        }
        setSubmitterID(userID)

        // Build the request payload
        const payload = {
            establishmentName,
            address,
            city,
            state,
            zip,
            discount,
            submitterID : userID,
            lat : location.lat,
            lng : location.lng
        };

        // Send the form data to the server
        const requestOptions = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        };
        const backendUrl = 'http://localhost:5000';
        const submissionUrl = `${backendUrl}/submit`;
        try {
            const response = await fetch(submissionUrl, requestOptions);
            const data = await response.json();
            if (response.ok) {
                alert('Submission successful!');
            } else {
                alert('Submission failed. Please try again.');
            }
        }
        catch (error) {
            console.error('Submission error:', error);
            alert('Error submitting form. Please try again.');
        }

        setDisplayData({
            establishmentName,
            discount
        });    

        // Clear the form fields after submission
        setEstablishmentName('');
        setAddress('');
        setCity('');
        setState('');
        setZip('');
        setDiscount('');
    };

    // Function to handle map click


    return (
        &lt;div className="submission-container mt-7">
            &lt;div className="map-container">
                &lt;MapContainer center={[39.9526, -75.1652]} zoom={13} style={{ height: '400px', width: '100%' }} >
                    &lt;TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" attribution="&amp;copy; OpenStreetMap contributors" />
                    {location &amp;&amp; (
                        &lt;Marker position={location} icon={customIcon} key={`${DisplayData.establishmentName}-${DisplayData.discount}`}>
                        &lt;Popup>
                            &lt;strong>{DisplayData.establishmentName}&lt;/strong>
                            &lt;br />
                            {DisplayData.discount}
                        &lt;/Popup>
                     &lt;/Marker>
                    )}
                &lt;/MapContainer>
            &lt;/div>
            &lt;div className="form-fields-container">
                &lt;div className="form-container">
                    &lt;h2 className="mb-4">Submit Your Student Discount Review&lt;/h2>
                    &lt;form onSubmit={handleSubmit}>
                        &lt;div className="mb-3">
                            &lt;label htmlFor="establishmentName" className="form-label">Establishment Name&lt;/label>
                            &lt;input
                                type="text"
                                className="form-control"
                                placeholder="Ma and Pa's Bar and Grill"
                                id="establishmentName"
                                value={establishmentName}
                                onChange={(e) => setEstablishmentName(e.target.value)}
                                required
                            />
                        &lt;/div>
                        &lt;div className="address-fields mb-3">
                            &lt;input
                                type="text"
                                className="form-control"
                                placeholder="Street"
                                value={address}
                                onChange={(e) => setAddress(e.target.value)}
                                required
                            />
                            &lt;input
                                type="text"
                                className="form-control"
                                placeholder="City"
                                value={city}
                                onChange={(e) => setCity(e.target.value)}
                                required
                            />
                            &lt;input
                                type="text"
                                className="form-control"
                                placeholder="State"
                                value={state}
                                onChange={(e) => setState(e.target.value)}
                                required
                            />
                            &lt;input
                                type="text"
                                className="form-control"
                                placeholder="Zip Code"
                                value={zip}
                                onChange={(e) => setZip(e.target.value)}
                                required
                            />
                        &lt;/div>
                        &lt;div className="mb-3">
                            &lt;label htmlFor="discount" className="form-label">Discount Description&lt;/label>
                            &lt;textarea
                                className="form-control"
                                placeholder='Bogo Fridays for temple students'
                                id="discount"
                                value={discount}
                                onChange={(e) => setDiscount(e.target.value)}
                                required
                                rows="4"
                            />
                        &lt;/div>                        
                        &lt;button type="submit" className="btn btn-primary">Submit Review&lt;/button>
                    &lt;/form>
                &lt;/div>
            &lt;/div>
        &lt;/div>
    );
}


export default SubmissionPage;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Wed Apr 24 2024 18:26:27 GMT-0400 (Eastern Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
